import gensim
from gensim import models
from gensim import corpora
from pprint import pprint
from gensim.utils import simple_preprocess
from smart_open import smart_open
import os
import numpy as np
from nltk.corpus import stopwords
import re
import logging
import gensim.downloader as api
from gensim.utils import simple_preprocess, lemmatize
from gensim.models import LdaModel, LdaMulticore
import pandas as pd
import pickle
import matplotlib.pyplot as plt
from gensim.models.coherencemodel import CoherenceModel
from collections import Counter
from gensim.models.wrappers import LdaMallet
import csv
import copy

# Plotting tools 
import pyLDAvis
import pyLDAvis.gensim  # don't skip this
import matplotlib.pyplot as plt
#%matplotlib inline


# spacy for lemmatization
import spacy

#C:\Users\imasi\Desktop\Testingfor 4480\TRIALS\Full data set\RUN 2

#"/mnt/c/Documents and Settings/imasi/Desktop/Testingfor 4480/newwords/"
#C:\Users\imasi\Desktop\Testingfor 4480\NEWRESULTS
#C:\Users\imasi\Desktop\Testingfor 4480\TRIALS\5 ---- seems to get really nice data
#table_MN = pd.read_html('/mnt/c/Documents and Settings/imasi/Desktop/Testingfor 4480/TRIALS/5 ---- seems to get really nice data/df1.html')
table_MN = pd.read_html('/mnt/c/Documents and Settings/imasi/Desktop/Testingfor 4480/AllFolders/NEWRESULTS/df1OMGGOOD.html')
table_MNN = pd.read_html('/mnt/c/Documents and Settings/imasi/Desktop/Testingfor 4480/AllFolders/NEWRESULTS/dataframeOMGGOOD.html')
df = table_MN[0]
df1 = table_MNN[0]
#df.head()
print(df.info())
df = df.drop(0)
print(df)
# maxInt = 0

# for i in range(len(table_MN[0])):

#     if int(df['Dominant_Topic'][i]) > maxInt:
#         maxInt = int(df['Dominant_Topic'][i])

# holder = []

# arryDict = []

# malwareDict = {}

# for i in range(len(table_MN[0])):
#     malwareDict[df['Name'][i][33:]] = 0

#print(id(malwareDict))

listColumn = list(df.columns)
listColumn.pop(0)
print(listColumn)

holderV = []

for i in listColumn:
    sumV = 0
    sumP = -1
    for j in range(1,len(df[i])):
        #print(j)
        if df[i][j] > sumV:
            sumV = df[i][j]
            sumP = j
    holderV.append(sumP)

print(holderV)
        
isB = []

counterVal = 0


# for j in holderV:
#     zholder = []
#     for i in range(10):
#         if j == i:
#             zholder.append(listColumn[i])
#     isB.append(zholder)



for i in range(32):
    zholder = []
    #for j in 
    for j in range(len(holderV)):
        if holderV[j] == i:
            zholder.append(listColumn[j])
            #break
    isB.append(zholder)
    
print(isB)
    
TP = 0
TN = 0
FP = 0
FN = 0

TruP = []

for i in range(len(isB)):
    TP = 0
    TN = 0
    FP = 0
    FN = 0
    pHolder = []
    if len(isB[i]) == 0:
        print('empty')
    else:
        print(isB[i])
        for j in isB[i]:
            TP = df[j][i] + TP
            TN = sum(df[j]) + TN
            
            #print(FP)
            
        FP = sum(df.xs(i)) - TP
        print(FP)
        TN = TN - TP
        #print(FP)
        pHolder.append(TP)
        pHolder.append(TN)
        pHolder.append(FP)
        print(pHolder)
    TruP.insert(i,pHolder)

print(TruP)


#print(df1.info())

TrueP = 0
TrueN = 0
FalseP = 0
FalseN = 0

holdS = []
holdB = []


for i in range(len(listColumn)):
    #print(i)
    ssss = []
    zzzz = []
    for j in range(len(df1['Name'])):
        #print(int(df1['Dominant_Topic'][j]))
        #print(holderV[i])
        if listColumn[i] == df1['Name'][j][33:] and df1['Dominant_Topic'][j]==holderV[i]:
            val = df1['Topic_Perc_Contrib'][j]
            zzzz.append(val)
        if listColumn[i] == df1['Name'][j][33:]:
            val = df1['Topic_Perc_Contrib'][j]
            ssss.append(val)
    holdS.append(ssss)
    holdB.append(zzzz)

#print(holdS)
print(len(holdS))
print(len(holdB))
#print(len(listColumn))
#print(len(holdS[0]))

zzn = []
zzs = []
for i in range(len(holdS)):
    tp1 = 0
    tn1 = 0
    tp2 = 0
    tn2 = 0
    zc = []
    zs = []
    for j in holdS[i]:
        if j >= .84:
            tp1 += 1
        else:
            tn1 += 1
    for j in holdB[i]:
        if j >= .84:
            tp2 += 1
        else:
            tn2 += 1
    zc.append(tp1-tp2)
    zc.append(tn1-tn2)
    zs.append(tp2)
    zs.append(tn2)
    zzn.append(zc)
    zzs.append(zs)

print(zzn)
print(zzs)


calcPresaRec = []

for i in range(len(zzn)):
    tp = zzs[i][0]
    tn = zzn[i][0]
    fp = zzs[i][1]
    fn = zzn[i][1]
    prec = tp/(tp+fp)
    #recall = tp/(tp+fn)
    accur = (tp+tn)/(tp+tn+fp+fn)
    #specif = tn/(tn+fp)
    misclar = (fp+fn)/(tp+tn+fp+fn)
    if tn+fp == 0:
        specif = -1
    else:
        specif = tn/(tn+fp)

    if tp+fn == 0:
        recall = -1
    else:
        recall = tp/(tp+fn)


    if recall+prec != 0:
        f1sc = 2*(recall*prec)/(recall+prec)
    else:
        f1sc = -1
    calcPresaRec.append([('%.4f' % prec),('%.4f' % recall),('%.4f' % f1sc),('%.4f' % accur),('%.4f' % specif),('%.4f' % misclar)])

print(calcPresaRec)

newdf = pd.DataFrame(calcPresaRec)
newdf.columns = ["Precision",'Recall',"F1_Score","Accuracy","Specificity","Misclassification"]
newdf.index = listColumn
print(newdf)

newdf.to_html("AllFolders/NEWRESULTS/Prec_Recall11111111111.html")


# zzn = []
# for i in holdB:
#     tp = 0
#     tn = 0
#     zc = []
#     for j in i:
#         if j >= .85:
#             tp += 1
#         else:
#             tn += 1
#     zc.append(tp)
#     zc.append(tn)
#     zzn.append(zc)

# print(zzn)